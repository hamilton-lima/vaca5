var NMSColor={VINE_TOMATO:"#EF5026",EGGPLANT:"#3C3755",RED_PEPPER:"#C52728",PURPLE_CABBAGE:"#8E4980",BROCCOLI:"#2C401B",BRUSSELS_SPROUTS:"#86A23E",POTATO:"#D79851",RHUBARB:"#C15866",APPLE:"#E5493D",DRAGON_FRUIT:"#EEA24E",OKRA:"#5E7434",JICAMA:"#CB726E",FENNEL:"#CBC7A1",LEMON:"#FAF599",APRICOT:"#FFBE30",AVOCADO:"#C9C561",BLUEBERRY:"#353535",SOUR_CHERRY:"#AF1317",BEET:"#D73C2A",ASPERAGUS:"#C6BD62",WATERCRESS:"#9FB43B",TANGERINE:"#FAA21D",BANANA:"#FDDF6F",SPRING_ONION:"#702C23",PEAR:"#C8C846",CHARD:"#547838",
FIG:"#68281F",GOLDEN_KIWI:"#F6D063",YELLOW_BELLPEPPER:"#FDC647",SQUASH_BLOSSOM:"#ECCC55",RED_KIDNEY_BEAN:"#CB9274",TANGERINE:"#FAA21D",SQUASH:"#FBE70E",PERSIMMON:"#FAA21D",MUSCAT_GRAPES:"#AD709A",RED_BELLPEPPER:"#D12728",CARROT:"#E75F25",GREEN_CABBAGE:"#B4C346",PINEAPPLE:"#E2A528",DRAGON_FRUIT:"#C9A62E",ZUCCHINI:"#93A13F",KALE:"#47642E",CUCUMBER:"#456033",PEACH:"#F47747",FIDDLEHEAD:"#597A41",PURPLE_CAULIFLOWER:"#753C67",CARAMBOLA:"#E1B828",PAPAYA:"#EFAE20",LONG_BEAN:"#8A9E6D",STRAWBERRY:"#D62D28",
TURNIP:"#B64885",RADISH:"#B32225",PLANTINE:"#ECCC55",RHUBARB:"#B37872",ARTICHOKE:"#879C3D",BUTTER_SQUASH:"#ECB481",ENDIVE:"#FAF599",MANGOSTEEN:"#9A1C1F"};function ResourceManager(){this.images=[];this.sounds=[];this.active=!1;this.imagesCallbacks=[];this.soundsCallbacks=[];this.interval=50;this.percentage=function(){var b=0;for(key in _resourceManager.imagesCallbacks)b++;var a=0;for(key in _resourceManager.images)a++;b=(a-b)/a;a==0&&(b=0);return b};this.addImage=function(b,a){var c=new Image;c.src=b;this.imagesCallbacks[b]||(this.imagesCallbacks[b]=[]);this.imagesCallbacks[b].push(a);this.images[b]=c;if(!this.active)this.active=!0,_resourceManager_update()}}
var _resourceManager=new ResourceManager;
function _resourceManager_update(){for(src in _resourceManager.images){var b=_resourceManager.imagesCallbacks[src];if(b&&_resourceManager.images[src].complete&&_resourceManager.images[src].width>0&&_resourceManager.images[src].height>0){for(target in b){var a=b[target];a.callback(a,_resourceManager.images[src])}delete _resourceManager.imagesCallbacks[src]}}b=0;for(key in _resourceManager.imagesCallbacks)b++;b>0?setTimeout(_resourceManager_update,_resourceManager.interval):_resourceManager.active=
!1};function GridLayout(b,a,c,g,e,d,f){this.from=Scene;this.from();this.invalid=!0;this.x=b;this.y=a;this.width=c;this.height=g;this.currentColumn=this.currentLine=0;this.border=f;this.lines=e;this.columns=d;this.childs=[];this.sumOfWidth=this.childHeight=this.childWidth=0;this.columnPercentage=[];this.recalculate=function(){var c=this.currentColumn=this.currentLine=0;this.childWidth=(this.width-this.border*(this.columns+1))/this.columns;this.childHeight=(this.height-this.border*(this.lines+1))/this.lines;
for(key in this.childs){child=this.childs[key];child.width=this.childWidth;if(this.columnPercentage.length>this.currentColumn)child.width=child.width*this.columns*this.columnPercentage[this.currentColumn];child.height=this.childHeight;child.x=this.x+(this.currentColumn+1)*this.border+c;c+=child.width;child.y=this.y+(this.currentLine+1)*this.border+this.currentLine*this.childHeight;child.invalid=!0;this.currentColumn++;if(this.currentColumn>=this.columns)this.currentColumn=0,this.currentLine++,c=0}};
this.recalculate();this.add=function(c){c.width=this.childWidth;if(this.columnPercentage.length>this.currentColumn)c.width=c.width*this.columns*this.columnPercentage[this.currentColumn];c.height=this.childHeight;c.x=this.x+(this.currentColumn+1)*this.border+this.sumOfWidth;this.sumOfWidth+=c.width;c.y=this.y+(this.currentLine+1)*this.border+this.currentLine*this.childHeight;c.invalid=!0;this.childs.push(c);this.currentColumn++;if(this.currentColumn>=this.columns)this.sumOfWidth=this.currentColumn=
0,this.currentLine++};this.update=function(c,a,d){if(d.invalid)d.recalculate(),d.invalid=!1;this.beforeUpdate(c,b);this.clearBackGround(c.ctx);var b=null;for(key in this.childs)b=this.childs[key],b.update&&b.update(c,d,b)}};function Transition(b){this.nextScene=b;this.nextScreen=this.previousScreen=null;this.finished=this.ready=!1;this.steps=0;this.currentStep=1;this.speed=15;this.expectedFPS=60;this.effectFunction=null;this.EFFECT_SLIDE_LEFT=1;this.EFFECT_SLIDE_RIGHT=2;this.EFFECT_SLIDE_TOP=3;this.EFFECT_SLIDE_DOWN=4;this.EFFECT_SLIDE_FADE=5;this.effect=this.EFFECT_SLIDE_LEFT;this.update=function(a,c){c.effectFunction&&c.effectFunction(a,c)};this.start=function(a,c){if(!c.previousScreen){var b=a.ctx.getImageData(0,
0,a.width,a.height);c.previousScreen=document.createElement("canvas");c.previousScreen.width=a.width;c.previousScreen.height=a.height;c.previousScreen.getContext("2d").putImageData(b,0,0)}if(!c.nextScreen)c.nextScreen=document.createElement("canvas"),c.nextScreen.width=a.width,c.nextScreen.height=a.height,b=a.ctx,a.ctx=c.nextScreen.getContext("2d"),c.nextScene.start(a),c.nextScene.update(a),a.ctx=b;c.ready=!0;if(c.effect==c.EFFECT_SLIDE_LEFT)c.effectFunction=_effectSlideLeft,c.steps=a.width;if(c.effect==
c.EFFECT_SLIDE_RIGHT)c.effectFunction=_effectSlideRight,c.steps=a.width;if(c.effect==c.EFFECT_SLIDE_TOP)c.effectFunction=_effectSlideTop,c.steps=a.height;if(c.effect==c.EFFECT_SLIDE_DOWN)c.effectFunction=_effectSlideDown,c.steps=a.height;if(c.effect==c.EFFECT_FADE)c.effectFunction=_effectFade,c.steps=a.height}}
function _effectSlideLeft(b,a){if(a.ready&&!a.finished){var c=b.width-a.currentStep,g=a.speed*(a.expectedFPS/b.lastFPS);b.ctx.drawImage(a.previousScreen,-a.currentStep,0);b.ctx.drawImage(a.nextScreen,c,0);a.currentStep+=g}if(a.currentStep>a.steps)a.finished=!0}
function _effectSlideRight(b,a){if(a.ready&&!a.finished){var c=-b.width+a.currentStep,g=a.speed*(a.expectedFPS/b.lastFPS);b.ctx.drawImage(a.previousScreen,a.currentStep,0);b.ctx.drawImage(a.nextScreen,c,0);a.currentStep+=g}if(a.currentStep>a.steps)a.finished=!0}
function _effectSlideTop(b,a){if(a.ready&&!a.finished){var c=-b.height+a.currentStep,g=a.speed*(a.expectedFPS/b.lastFPS);b.ctx.drawImage(a.previousScreen,0,a.currentStep);b.ctx.drawImage(a.nextScreen,0,c);a.currentStep+=g}if(a.currentStep>a.steps)a.finished=!0}
function _effectSlideDown(b,a){if(a.ready&&!a.finished){var c=b.height-a.currentStep,g=a.speed*(a.expectedFPS/b.lastFPS);b.ctx.drawImage(a.previousScreen,0,-a.currentStep);b.ctx.drawImage(a.nextScreen,0,c);a.currentStep+=g}if(a.currentStep>a.steps)a.finished=!0}
function _effectFade(b,a){if(a.ready&&!a.finished){var c=a.steps/2;a.currentStep<c?(c=a.currentStep/c,b.ctx.drawImage(a.previousScreen,0,0)):(c=1-(a.currentStep-c)/c,b.ctx.drawImage(a.nextScreen,0,0));b.ctx.fillStyle="rgba(0, 0, 0, "+c+")";b.ctx.fillRect(0,0,b.width,b.height);a.currentStep+=a.speed*(a.expectedFPS/b.lastFPS)}if(a.currentStep>a.steps)a.finished=!0};function ColisionManager(){this.sizeY=this.sizeX=10;this.handlers=[];this.regions=Array(10);for(var b=0;b<this.sizeX;b++){this.regions[b]=Array(this.sizeY);for(var a=0;a<this.sizeY;a++)this.regions[b][a]=[]}this.add=function(c){c.regionX=Math.floor(c.x)%this.sizeX;c.regionY=Math.floor(c.y)%this.sizeY;c.regionX1=Math.floor(c.x+c.width)%this.sizeX;c.regionY1=Math.floor(c.y+c.height)%this.sizeY;if(c.regionX<=0)c.regionX=0;if(c.regionY<=0)c.regionY=0;game.debug.log("regions "+c.regionX+" "+c.regionY+
" "+c.x+" "+c.y);this.regions[c.regionX][c.regionY].push(c)};this.move=function(c){for(key in this.regions[c.regionX][c.regionY])if(c.id==this.regions[c.regionX][c.regionY][key].id){delete this.regions[c.regionX][c.regionY][key];break}this.add(c)};this.colide=function(c,a,b){for(key in this.handlers)if(handler=this.handlers[key],handler(c,a,b))return c.debug.log("colision processing interrupted."),!0};this.update=function(c){this.checkColision(c)};this.checkColision2=function(c){for(var a=c.currentScene.childs,
b=0;b<a.length;b++)if(a[b].isColidable){var d=this.regions[a[b].regionX][a[b].regionY];for(key in d)d[key].id!=a[b].id&&d[key].isColidable&&a[b].intersects(d[key].x,d[key].y,d[key].width,d[key].height)&&this.colide(c,a[b],d[key]);for(var f=a[b].regionY+1;f<=a[b].regionY1;f++)for(key in d=this.regions[a[b].regionX][f],d)d[key].id!=a[b].id&&d[key].isColidable&&a[b].intersects(d[key].x,d[key].y,d[key].width,d[key].height)&&this.colide(c,a[b],d[key]);for(f=a[b].regionX+1;f<=a[b].regionX1;f++)for(key in d=
this.regions[f][a[b].regionY],d)d[key].id!=a[b].id&&d[key].isColidable&&a[b].intersects(d[key].x,d[key].y,d[key].width,d[key].height)&&this.colide(c,a[b],d[key]);for(f=a[b].regionY+1;f<=a[b].regionY1;f++)for(var i=a[b].regionX+1;i<=a[b].regionX1;i++)for(key in d=this.regions[i][f],d)d[key].id!=a[b].id&&d[key].isColidable&&a[b].intersects(d[key].x,d[key].y,d[key].width,d[key].height)&&this.colide(c,a[b],d[key])}};this.checkColision=function(a){for(var b=a.currentScene.childs,e=0;e<b.length;e++)if(b[e].isColidable){for(var d=
e-1,f=0;f<d;f++)b[f].isColidable&&b[e].intersects(b[f].x,b[f].y,b[f].width,b[f].height)&&this.colide(a,b[e],b[f]);d=b.length;for(f=e+1;f<d;f++)b[f].isColidable&&b[e].intersects(b[f].x,b[f].y,b[f].width,b[f].height)&&this.colide(a,b[e],b[f])}};this.listColision=function(a,b){for(var e=[],d=a.currentScene.childs,f=0;f<d.length;f++)d[f].isColidable&&d[f].id!=b.id&&d[f].intersects(b.x,b.y,b.width,b.height)&&e.push(d[f]);return e};this.listColision=function(a,b,e,d,f,i){for(var j=[],a=a.currentScene.childs,
h=0;h<a.length;h++)a[h].isColidable&&a[h].id!=b&&a[h].intersects(e,d,f,i)&&j.push(a[h]);return j}};function Rectangle(b,a,c,g,e){this.id=b;this.x=a;this.y=c;this.width=g;this.height=e;this.fixed=this.remove=!1;this.dragY=this.dragX=-1;this.debug=this.isColidable=this.isDraggable=this.isDragging=!1;this.fillColor=NMSColor.AVOCADO;this.borderColor=NMSColor.BLUEBERRY;this.border=2;this.pointerDownCallbacks=[];this.pointerUpCallbacks=[];this.pointerMoveCallbacks=[];this.pointerDown=function(a,b,c,e){for(key in this.pointerDownCallbacks)if((callback=this.pointerDownCallbacks[key])&&callback(a,b,c,e))return a.debug.log("event consumed - interrupt processing of pointerdown"),
!0};this.pointerUp=function(a,b,c,e){for(key in this.pointerUpCallbacks)if((callback=this.pointerUpCallbacks[key])&&callback(a,b,c,e))return a.debug.log("event consumed - interrupt processing of pointerup"),!0};this.pointerMove=function(a,b,c,e){for(key in this.pointerMoveCallbacks)if((callback=this.pointerMoveCallbacks[key])&&callback(a,b,c,e))return a.debug.log("event consumed - interrupt processing of pointermove (2)"),!0};this.pointerDownCallbacks.push(function(a,b,c,e){e.dragX=b;e.dragY=c;if(e.isDraggable)e.isDragging=
!0;return!0});this.drag=function(a,b,c,e){this.debug&&a.debug.log("moved "+b+"/"+c+" drag:"+e.isDraggable+" dragging:"+e.isDragging+" id:"+e.id);if(e.isDraggable&&e.isDragging)return e.x+=b-e.dragX,e.y+=c-e.dragY,e.dragX=b,e.dragY=c,!0};this.beforeUpdate=function(){};this.update=function(a,b,c){this.beforeUpdate(a,b,c);if(this.width<1||this.height<1)a.debug.warn("update of not loaded : "+this.id+" "+this.width+" "+this.height);else if(this.fixed)b=a.ctx,b.strokeStyle=this.borderColor,b.lineWidth=
this.border,b.fillStyle=this.fillColor,c=this.x,a=this.y,b.beginPath(),b.moveTo(c,a),b.lineTo(c+this.width,a),b.lineTo(c+this.width,a+this.height),b.lineTo(c,a+this.height),b.lineTo(c,a),b.fill(),b.stroke(),b.closePath();else if(this.intersects(a.viewport.x,a.viewport.y,a.viewport.width,a.viewport.height))b=a.ctx,b.strokeStyle=this.borderColor,b.lineWidth=this.border,b.fillStyle=this.fillColor,c=this.x-a.viewport.x,a=this.y-a.viewport.y,b.beginPath(),b.moveTo(c,a),b.lineTo(c+this.width,a),b.lineTo(c+
this.width,a+this.height),b.lineTo(c,a+this.height),b.lineTo(c,a),b.fill(),b.stroke(),b.closePath()};this.has=function(a,b){return a>this.x&&b>this.y&&a<this.x+this.width&&b<this.y+this.height};this.intersects=function(a,b,c,e){var g=this.x,k=this.y,l=this.width,m=this.height;return!(g>a+c||a>g+l||k>b+e||b>k+m)}};function Grid(b,a,c,g,e,d,f,i){this.from=GridLayout;this.from();this.x=a;this.y=c;this.width=g;this.height=e;this.lines=d;this.columns=f;this.border=i;this.fontSize=12;this.setHeaderColor=NMSColor.FENNEL;this.setDataColor=NMSColor.ENDIVE;this.id=b;this.setData=function(a,b,c){var d=c.header,c=c.data;if(!d||!c)a.debug.error("no data or header was set");else{for(key in d)a=new Label(0,0,"header_"+key,d[key]),a.size=this.fontSize,a.backgroundColor=b.setHeaderColor,b.add(a);for(key in c)for(innerKey in c[key])d=
new Label(0,0,"data_"+key+"_"+innerKey,c[key][innerKey]),d.backgroundColor=b.setDataColor,d.size=this.fontSize,b.add(d)}}};function AudioManager(b){this.audioTracks=[];this.game=b;this.muted=!1;b=document.createElement("audio");this.canPlayMp3=""!=b.canPlayType("audio/mpeg");this.canPlayOgg=""!=b.canPlayType('audio/ogg; codecs="vorbis"');this.loadingStatus=function(){var a=0,b=0;for(key in this.audioTracks){a++;var g=this.audioTracks[key];this.game.debug.warn(key+" audio state : "+g.readyState);g.readyState>=g.HAVE_CURRENT_DATA&&b++}if(b==0)return 0;return b/a};this.register=function(a,b){if(!this.audioTracks[a]){var g=
new Audio("");if(b)g.loop=b,g.addEventListener("ended",function(){this.currentTime=0},!1);var e=g.autoplay=!1;this.canPlayMp3?e=a+".mp3":this.canPlayOgg&&(e=a+".ogg");e?(g.src=e,g.load(),this.audioTracks[a]=g):this.game.debug.warn("browser not able to play MP3 or OGG")}};this.play=function(a){this.audioTracks[a]?(a=this.audioTracks[a],a.isFlash?a.playFlash(a.src):a.play()):this.game.debug.warn("audio :"+a+" not registered")};this.pause=function(a){this.audioTracks[a]?this.audioTracks[a].pause():this.game.debug.warn("audio :"+
a+" not registered")};this.mute=function(){this.muted=!0;for(key in this.audioTracks)this.audioTracks[key].muted=!0};this.unmute=function(){this.muted=!1;for(key in this.audioTracks)this.audioTracks[key].muted=!1};this.setVolume=function(a){for(key in this.audioTracks)this.audioTracks[key].volume=a}};function Sprite(b,a,c,g){this.from=Rectangle;this.from();this.id=b;this.x=a;this.y=c;this.src=g;this.DEFAULT_STATE="__sds__";this.frames=4;this.position=this.current_frame=0;this.state=this.DEFAULT_STATE;this.__image_name=this.__image=null;this.states=[];this.states[this.DEFAULT_STATE]=[];this.states[this.DEFAULT_STATE][this.states[this.DEFAULT_STATE].length]=g;this.callback=function(a,b){a.width=b.width;a.height=b.height};this.setState=function(a){this.state=a;this.current_frame=this.position=0};
this.addState=function(a,b){this.states[a]||(this.states[a]=[]);this.states[a][this.states[a].length]=b;_resourceManager.addImage(b,this)};this.update=function(a,b,c){c.beforeUpdate(a,b,c);this.current_frame++;if(this.current_frame>this.frames)this.position=(this.position+1)%this.states[this.state].length,this.current_frame=0;this.__image_name=this.states[this.state][this.position];this.__image=_resourceManager.images[this.__image_name];this.__image.complete&&this.__image.width>0&&this.__image.height>
0?this.fixed?(b=this.x,c=this.y,a.ctx.drawImage(this.__image,b,c,this.__image.width,this.__image.height)):this.intersects(a.viewport.x,a.viewport.y,a.viewport.width,a.viewport.height)&&(b=this.x-a.viewport.x,c=this.y-a.viewport.y,a.ctx.drawImage(this.__image,b,c,this.__image.width,this.__image.height)):a.debug.warn("update of sprite not ready : "+this.id+" : "+this.__image_name)};_resourceManager.addImage(g,this)};function Label(b,a,c,g){this.from=Rectangle;this.from();this.x=b;this.y=a;this.id=c;this.text=g;this.size=20;this.font="Helvetica";this.debug=!1;this.invalid=!0;this.innerBorder=2;this.valign=this.align="center";this.textHeight=this.textWidth=null;this.fillColor=NMSColor.EGGPLANT;this.borderColor=NMSColor.BLUEBERRY;this.backgroundColor=null;this.border=1;this.setDebug=function(a){this.debug=a};this.setText=function(a){this.text=a;this.invalid=!0};this.calculateMetrics=function(a){a.ctx.font=this.size+
"px "+this.font;a.ctx.textBaseline="top";this.textWidth=a.ctx.measureText(this.text).width;this.textHeight=this.size;if(!this.width)this.width=this.textWidth;if(!this.height)this.height=this.textHeight;this.debug&&a.debug.log(this.id+" font bounding box : "+this.width+"/"+this.height)};this.start=function(a){this.calculateMetrics(a)};this.beforeUpdate=function(){};this.update=function(a,b,c){this.beforeUpdate(a,b,c);if(this.width<=0||this.height<=0)a.debug.warn("update of not loaded : "+this.id);
else{this.invalid&&this.calculateMetrics(a);b=a.ctx;if(c.backgroundColor)a.ctx.fillStyle=c.backgroundColor,a.ctx.beginPath(),a.ctx.rect(this.x,this.y,this.width,this.height),a.ctx.closePath(),a.ctx.fill();b.strokeStyle=this.borderColor;b.lineWidth=this.border;b.fillStyle=this.fillColor;b.textBaseline="top";b.font=this.size+"px "+this.font;var c=this.x,g=this.y;c+=this.align=="center"?(this.width-this.textWidth)/2:this.innerBorder;g+=this.valign=="center"?(this.height-this.textHeight)/2:this.innerBorder;
this.fixed?(b.fillText(this.text,c,g),this.debug&&b.strokeRect(c,g,this.width,this.height)):this.intersects(a.viewport.x,a.viewport.y,a.viewport.width,a.viewport.height)&&(c-=a.viewport.x,g-=a.viewport.y,b.fillText(this.text,c,g),this.debug&&b.strokeRect(c,g,this.width,this.height))}}};function Scene(b,a){this.y=this.x=0;this.width=b;this.height=a;this.childs=[];this.background="#000000";this.pointerDownCallbacks=[];this.pointerUpCallbacks=[];this.pointerMoveCallbacks=[];this.transition=null;this.pointerDownCallbacks.push(function(a,b,e){for(var d=a.currentScene.childs,f=d.length-1;f>=0;f--)if(d[f].has&&d[f].has(b,e)&&d[f].pointerDown(a,b,e,d[f]))break});this.pointerUpCallbacks.push(function(a,b,e){for(var d=a.currentScene.childs,f=d.length-1;f>=0;f--)if(d[f].has&&d[f].has(b,e)&&
d[f].pointerUp(a,b,e,d[f]))break;for(key in d)child=d[key],child.isDragging=!1});this.pointerMoveCallbacks.push(function(a,b,e){var d=a.currentScene.childs;for(key in d)child=d[key],child.isDragging&&child.drag(a,b,e,child);for(var f=d.length-1;f>=0;f--)if(d[f].has&&d[f].has(b,e)&&d[f].pointerMove(a,b,e,d[f]))break});this.beforeUpdate=function(){};this.update=function(a,b){this.beforeUpdate(a,b);this.clearBackGround(a.ctx);var e=null;for(key in this.childs){e=this.childs[key];try{e.update&&e.update(a,
b,e)}catch(d){a.debug.error("error on update : "+d)}}for(var f=0;f<this.childs.length;f++)e=this.childs[f],e.remove&&this.childs.splice(f,1)};this.start=function(a){a.debug.log("scene start");var b=null;for(key in this.childs)b=this.childs[key],b.start&&b.start(a,b)};this.clearBackGround=function(a){a.fillStyle=this.background;a.beginPath();a.rect(this.x,this.y,this.width,this.height);a.closePath();a.fill()};this.setBackground=function(a){this.background=a};this.add=function(a){this.childs.push(a)};
this.find=this.findById=function(a){var b=null,e;for(e in this.childs)if(b=this.childs[e],b.id==a)return b;return null}}function SceneEmpty(b,a){this.from=Scene;this.from();this.add(new Label(10,30,"_title","Empty scene."));this.setBackground(NMSColor.BANANA);this.width=b;this.height=a}
function SceneLoading(b,a,c){this.from=Scene;this.from();this.setBackground("#000000");this.nextScene=c;var g=b*0.9,e=(b-g)/2,d=a-20;this.barWidth=g;this.start=function(a,b){var c=new Label(0,0,"_title_loading","Loading");c.calculateMetrics(a);c.x=(a.width-c.width)/2;c.y=(a.height-c.height)/2;c.fillColor="#CCCCCC";c.borderColor="#CCCCCC";b.add(c);var c=new Rectangle("back_loading",e,d,g,5),h=new Rectangle("front_loading",e,d,1,5);c.fillColor="#CCCCCC";c.borderColor="#CCCCCC";h.fillColor=NMSColor.PAPAYA;
h.borderColor=NMSColor.PAPAYA;b.add(c);b.add(h);b.findById("front_loading").width=b.barWidth*_resourceManager.percentage()};this.beforeUpdate=function(a,b){var c=b.findById("front_loading"),d=_resourceManager.percentage();c.width=b.barWidth*d;if(c.width<1)c.width=1;if(d>=1)b.transition=new Transition(b.nextScene),b.transition.effect=b.transition.EFFECT_FADE};this.width=b;this.height=a};function DebugMessage(b,a){this.level=b;this.text=a}
function Debug(b){this.ERROR=1;this.WARN=2;this.LOG=3;this.INFO=4;this.limit=15;this.debugDiv=document.getElementById(b);this.messages=[];this.level=this.WARN;this.error=function(a){this.addMessage(this.ERROR,a)};this.warn=function(a){this.addMessage(this.WARN,a)};this.log=function(a){this.addMessage(this.LOG,a)};this.info=function(a){this.addMessage(this.INFO,a)};this.addMessage=function(a,b){this.level<a||(this.messages.unshift(new DebugMessage(a,b)),this.show())};this.levelLabel=function(a){var b=
"#N/D";switch(a){case 1:b="ERROR";break;case 2:b="WARN";break;case 3:b="LOG";break;case 4:b="INFO"}return b};this.show=function(){this.messages.length>this.limit&&this.messages.pop();if(this.debugDiv){var a="<b>debug</b><br>";for(key in this.messages){var b=this.messages[key];this.level>=b.level&&(a+=this.levelLabel(b.level)+" "+b.text+"<br>")}this.debugDiv.innerHTML=a}}}
function ShowAllPressedKeys(){this.update=function(b){var a=">";for(key in b.keyPressed)b.keyPressed[key]&&(a+=key+" ");b.ctx.strokeText(a,10,200)}}function ShowViewPort(){this.update=function(b){b.debug.warn("viewport : "+b.viewport.x+"/"+b.viewport.y)}};var BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(b){for(var a=0;a<b.length;a++){var c=b[a].string,g=b[a].prop;this.versionSearchString=b[a].versionSearch||b[a].identity;if(c){if(c.indexOf(b[a].subString)!=-1)return b[a].identity}else if(g)return b[a].identity}},
searchVersion:function(b){var a=b.indexOf(this.versionSearchString);if(a!=-1)return parseFloat(b.substring(a+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,
subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],
dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};function ProgressBar(b,a,c,g,e,d,f){this.from=Rectangle;this.from();this.superUpdate=this.update;this.id=b;this.x=a;this.y=c;this.width=g;this.height=e;this.position=d;this.max=f;this.defaultWidth=g-2*this.border;this.frontRect=new Rectangle(b+"_front_loading",a+this.border,c+this.border,this.defaultWidth*(d/f),e-2*this.border);this.defaultWidth=g-this.border;this.borderColor=this.fillColor="#555555";this.frontRect.fillColor=NMSColor.PAPAYA;this.frontRect.borderColor=NMSColor.PAPAYA;this.frontRect.border=
0;this.setBarColor=function(a){this.frontRect.fillColor=a;this.frontRect.borderColor=a};this.update=function(a,b,c){this.superUpdate(a,b,c);if(this.frontRect.width<=0||this.frontRect.height<=0)a.debug.warn("update of not loaded : "+this.id);else{this.frontRect.fixed=this.fixed;this.frontRect.width=this.defaultWidth*(this.position/this.max);if(this.frontRect.width<1)this.frontRect.width=1;this.frontRect.update(a,b,c)}}};function ViewportManager(b,a,c,g,e){this.followTarget=b;this.leftLimit=a;this.rightLimit=c;this.topLimit=g;this.bottomLimit=e;this.update=function(a){if(this.followTarget.width<=0||this.followTarget.height<=0||this.leftLimit.width<=0||this.leftLimit.height<=0||this.rightLimit.width<=0||this.rightLimit.height<=0||this.topLimit.width<=0||this.topLimit.height<=0||this.bottomLimit.width<=0||this.bottomLimit.height<=0)a.debug.warn("progress bar update with not ready objects.");else{var b=this.followTarget.y-
(a.viewport.height-this.followTarget.height)/2;a.viewport.x=this.followTarget.x-(a.viewport.width-this.followTarget.width)/2;a.viewport.y=b;if(this.rightLimit.intersects(a.viewport.x,a.viewport.y,a.viewport.width,a.viewport.height))a.viewport.x=this.rightLimit.x-a.viewport.width;if(this.leftLimit.intersects(a.viewport.x,a.viewport.y,a.viewport.width,a.viewport.height))a.viewport.x=this.leftLimit.x+this.leftLimit.width;if(this.topLimit.intersects(a.viewport.x,a.viewport.y,a.viewport.width,a.viewport.height))a.viewport.y=
this.topLimit.y+this.topLimit.height;if(this.bottomLimit.intersects(a.viewport.x,a.viewport.y,a.viewport.width,a.viewport.height))a.viewport.y=this.bottomLimit.y-a.viewport.height}}};var game=null;
function Game(b,a){this.VERSION="20120109-animate";this.width=b;this.height=a;this.debug=new Debug("debug_div");this.audio=new AudioManager(this);this.canvas=this.ctx=null;this.currentScene=new SceneEmpty(this.width,this.height);this.supportsTouch=!1;this.VIEWPORT_NAME="_viewport";this.viewport=new Rectangle(this.VIEWPORT_NAME,0,0,b,a);this.osName=this.version=this.browser=null;this.lastFPS=this.frameCounter=0;this.showFPS=!0;this.fpsColor="#000000";this.keyPressed=[];this.keyMapping=_defaultKeyMapping();
this.colision=new ColisionManager;this.interval=25;this.keys=[];this.s=function(a){return this.keys[a]};this.def=function(a,b){this.keys[a]=null;this.keys[a]=b};this.update=function(){this.frameCounter++;if(this.currentScene.transition){if(this.currentScene.transition.ready?this.currentScene.transition.update(this,this.currentScene.transition):this.currentScene.transition.start(this,this.currentScene.transition),this.currentScene.transition.finished){var a=this.currentScene;this.currentScene=a.transition.nextScene;
this.currentScene.start(this);a.transition=null}}else if(this.colision.update(this),this.currentScene.update(this,this.currentScene),this.showFPS)this.ctx.font="10px helvetica",this.ctx.fillStyle=this.fpsColor,this.ctx.fillText(this.lastFPS+"FPS",10,10)};this.start=function(){this.ctx=this.canvas.getContext("2d");this.currentScene.start(this,this.currentScene);_update();_FPSCounter()};this.updateFPS=function(){this.lastFPS=this.frameCounter;this.frameCounter=0};this.isKeyPressed=function(a){var b=
null;for(key in this.keyMapping){var e=this.keyMapping[key];if(e.name==a){b=e.keys;break}}this.debug.log("isKeyPressed() target: "+b);e=!1;if(b)for(key in b){if(this.keyPressed[b[key]]){e=!0;break}}else this.debug.log("key: ["+a+"] not assigned.");return e}}function _keydown(b){game.currentScene.transition||(game.keyPressed[b.keyCode]=!0)}function _keyup(b){game.keyPressed[b.keyCode]=!1}function _update(){game.update();setTimeout(_update,game.interval)}
function _FPSCounter(){game.updateFPS();setTimeout(_FPSCounter,1E3)}function KeyMapping(b,a){this.keys=a;this.name=b}function _defaultKeyMapping(){var b=[];b.push(new KeyMapping("left",[37,65]));b.push(new KeyMapping("right",[39,68]));b.push(new KeyMapping("up",[38,87]));b.push(new KeyMapping("down",[40,83]));b.push(new KeyMapping("fire1",[13]));b.push(new KeyMapping("fire2",[32]));return b}
function initGame(b,a,c){b.width=a;b.height=c;game=new Game(a,c);BrowserDetect.init();game.browser=BrowserDetect.browser;game.version=BrowserDetect.version;game.osName=BrowserDetect.OS;window.addEventListener("keydown",_keydown,!0);window.addEventListener("keyup",_keyup,!0);game.supportsTouch="createTouch"in document;b.addEventListener("touchstart",_mouseDown,!1);b.addEventListener("touchmove",_mouseMove,!1);b.addEventListener("touchend",_mouseUp,!1);b.addEventListener("mousemove",_mouseMove,!1);
b.addEventListener("mouseup",_mouseUp,!1);b.addEventListener("mousedown",_mouseDown,!1);game.canvas=b;return game}function _mouseDown(b){if(!game.currentScene.transition)for(n in b=getTouches(b),b){var a=b[n],c=null;for(key in game.currentScene.pointerDownCallbacks)(c=game.currentScene.pointerDownCallbacks[key])&&c(game,a.x,a.y)}}
function _mouseUp(b){if(!game.currentScene.transition)if(b=getTouches(b),b.length<=0)for(key in game.currentScene.pointerUpCallbacks)(c=game.currentScene.pointerUpCallbacks[key])&&c(game);else for(n in b){var a=b[n],c=null;for(key in game.currentScene.pointerUpCallbacks)(c=game.currentScene.pointerUpCallbacks[key])&&c(game,a.x,a.y)}}
function _mouseMove(b){if(!game.currentScene.transition){var a=getTouches(b);for(n in a){var c=a[n],g=null;for(key in game.currentScene.pointerMoveCallbacks)(g=game.currentScene.pointerMoveCallbacks[key])&&g(game,c.x,c.y)}if(b.touches)b.preventDefault();else return!0}}function getTouches(b){var a=[];if(b.touches)for(var c=1;c<=b.touches.length;c++){var g=getCoords(b.touches[c-1]);a.push(g)}else g=getCoords(b),a.push(g);return a}
function getCoords(b){return b.offsetX?{x:b.offsetX,y:b.offsetY}:b.layerX?{x:b.layerX,y:b.layerY}:{x:b.pageX-game.canvas.offsetLeft,y:b.pageY-game.canvas.offsetTop}};
